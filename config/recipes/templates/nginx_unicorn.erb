upstream unicorn_<%= application %> {
  server unix:/tmp/unicorn.<%= application %>.sock fail_timeout=0;
}

<% [80, 443].each do |port| %>
  server {
    listen <%= port %> default deferred;
    # server_name example.com;
    root <%= current_path %>/public;

    if (-f $document_root/system/maintenance.html) {
      return 503;
    }
    error_page 503 @maintenance;
    location @maintenance {
      rewrite  ^(.*)$  /system/maintenance.html last;
      break;
    }

    <% if port == 443 %>
      ssl on;
      ssl_certificate /etc/ssl/<%= application %>.crt;
      ssl_certificate_key /etc/ssl/<%= application %>.key;
    <% end %>

    location ^~ /assets/ {
      gzip_static on;
      expires max;
      add_header Cache-Control public;
    }

    try_files $uri/index.html $uri @unicorn;
    location @unicorn {
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      <% if port == 443 %>proxy_set_header X-Forwarded-Proto https;<% end %>
      proxy_set_header Host $http_host;
      proxy_redirect off;
      proxy_pass http://unicorn_<%= application %>;
    }

    error_page 500 502 503 504 /500.html;
    client_max_body_size 4G;
    keepalive_timeout 10;
  }
<% end %>
